<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ğŸ’¬ JWT ì¸ì¦ ê¸°ë°˜ ì‹¤ì‹œê°„ ì±„íŒ… í…ŒìŠ¤íŠ¸</title>
  <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    input, button { margin: 5px 0; }
    ul { list-style: none; padding-left: 0; }
    li { margin: 3px 0; }
  </style>
</head>
<body>
<h2>ğŸ’¬ JWT ì¸ì¦ ê¸°ë°˜ ì±„íŒ… í…ŒìŠ¤íŠ¸</h2>

<label>ì‚¬ìš©ì ID:</label><br>
<input type="text" id="senderInput" placeholder="ì˜ˆ: user1"><br><br>

<label>ì±„íŒ…ë°© ID:</label><br>
<input type="text" id="roomIdInput" placeholder="ì˜ˆ: room123"><br><br>

<label>ğŸ”‘ Access Token (Bearer ì œì™¸):</label><br>
<input type="text" id="tokenInput" placeholder="eyJhbGciOi..." size="80"><br><br>

<button onclick="connect()">ğŸ”— ì—°ê²°</button>

<hr>

<input type="text" id="messageInput" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”" style="width: 300px;">
<button onclick="sendMessage()">ğŸ“¤ ë³´ë‚´ê¸°</button>

<ul id="chatBox"></ul>

<script>
  let stompClient = null;
  let connectedRoomId = null;
  let senderId = null;

  function connect() {
    senderId = document.getElementById("senderInput").value.trim();
    connectedRoomId = document.getElementById("roomIdInput").value.trim();
    const accessToken = document.getElementById("tokenInput").value.trim();

    if (!senderId || !connectedRoomId || !accessToken) {
      alert("ì‚¬ìš©ì ID, ì±„íŒ…ë°© ID, í† í°ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      return;
    }

    const socket = new SockJS("/ws-chat");
    stompClient = Stomp.over(socket);

    const headers = {
      token: "Bearer " + accessToken // âœ… ì„œë²„ì—ì„œ getFirstNativeHeader("token")ìœ¼ë¡œ ë°›ì•„ì•¼ í•¨
    };

    stompClient.connect(headers, function (frame) {
      console.log("âœ… WebSocket ì—°ê²° ì„±ê³µ:", frame);

      // âœ… ì—°ê²° í›„ êµ¬ë…
      stompClient.subscribe(`/topic/chat/${connectedRoomId}`, function (message) {
        const body = JSON.parse(message.body);
        const content = `[${body.sender}] ${body.message}`;
        const li = document.createElement("li");
        li.textContent = content;
        document.getElementById("chatBox").appendChild(li);
      });

      alert("âœ… ì±„íŒ…ë°©ì— ì…ì¥í•˜ì˜€ìŠµë‹ˆë‹¤.");
    }, function (error) {
      console.error("âŒ ì—°ê²° ì‹¤íŒ¨:", error);
      alert("WebSocket ì—°ê²° ì‹¤íŒ¨: " + error);
    });
  }

  function sendMessage() {
    const message = document.getElementById("messageInput").value.trim();
    if (!message || !stompClient || !connectedRoomId || !senderId) return;

    // ì„œë²„ì— ë©”ì‹œì§€ ì „ì†¡
    stompClient.send(`/app/api-user/chat.send.${connectedRoomId}`, {}, JSON.stringify({
      sender: senderId,
      message: message,
      type: "TALK"
    }));

    // ë‚´ í™”ë©´ì— ë©”ì‹œì§€ ë°”ë¡œ í‘œì‹œ
    const li = document.createElement("li");
    li.textContent = `[ë‚˜ (${senderId})] ${message}`;
    document.getElementById("chatBox").appendChild(li);

    document.getElementById("messageInput").value = "";
  }
</script>
</body>
</html>